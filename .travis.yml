language: python

env:
    matrix:
        # These ancient versions are linked to an old libgfortran, but that version
        # isn't pinned in the package metadata
        - PYTHON_VERSION=2.7
          PACKAGES="cython=0.17 numpy=1.10.0 matplotlib=1.5.1 nose proj4=4.9.1 scipy=0.16.0 libgfortran=1 mock futures"
        - PYTHON_VERSION=3.5
          PACKAGES="cython=0.23.1 numpy=1.10.0 matplotlib=1.5.1 nose proj4=4.9.1 scipy=0.16.0 libgfortran=1"
          PYTHONHASHSEED=0  # So pytest-xdist works.
        - NAME="Latest everything."
          PYTHON_VERSION=3.6
          PACKAGES="cython numpy matplotlib-base proj4 pykdtree scipy fiona"
        - NAME="Latest everything (py2k)."
          PYTHON_VERSION=2
          PACKAGES="cython numpy matplotlib proj4 scipy mock futures"


sudo: false

git:
  # Because we check the history of every file, we need to have
  # a deep clone of the repo.
  depth: 10000

install:
  # Install miniconda
  # -----------------
  - if [[ "$PYTHON_VERSION" == 2* ]]; then
      wget https://repo.continuum.io/miniconda/Miniconda2-latest-Linux-x86_64.sh -O miniconda.sh;
    else
      wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
    fi
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"

  # Create the basic testing environment
  # ------------------------------------
  - conda config --set always_yes yes --set changeps1 no --set show_channel_urls yes
  - conda config --add channels conda-forge
  - conda config --add channels conda-forge/label/testing
  - ENV_NAME="test-environment"
  - conda create -n $ENV_NAME python=$PYTHON_VERSION
  - source activate $ENV_NAME

  # Customise the testing environment
  # ---------------------------------
  - PACKAGES="$PACKAGES pillow pytest pytest-xdist filelock pep8 pyshp shapely six requests pyepsg owslib"
  - conda install --quiet $PACKAGES
  - pip install pytest-vcr

  # Conda debug
  # -----------
  - conda list -n $ENV_NAME
  - conda list -n $ENV_NAME --explicit
  - conda info -a

  - MPL_CONFIG_DIR=~/.config/matplotlib
  - mkdir -p $MPL_CONFIG_DIR
  - echo "backend" ":" "agg" > $MPL_CONFIG_DIR/matplotlibrc

  # Install cartopy
  # ---------------
  - pip install --no-deps .
  - python -c "import cartopy; print('Version ', cartopy.__version__)" && python setup.py version

script:
  # Check that the downloader tool at least knows where to get the data from (but don't actually download it)
  - python $TRAVIS_BUILD_DIR/tools/feature_download.py gshhs physical --dry-run

  - |
    PYTEST_ARGS=
    if [[ "$NAME" == "Latest everything"* ]]; then
      PYTEST_ARGS="$PYTEST_ARGS --doctest-modules"
    fi
    if [[ "$TRAVIS_EVENT_TYPE" == "cron" ]]; then
      PYTEST_ARGS="$PYTEST_ARGS --disable-vcr"
    else
      PYTEST_ARGS="$PYTEST_ARGS --vcr-record=none"
      # These are invalid, but ensure the tests aren't skipped. A valid
      # response is returned from vcrpy regardless of authentication.
      export SRTM_USERNAME=username SRTM_PASSWORD=password
    fi

  - CARTOPY_GIT_DIR=$TRAVIS_BUILD_DIR pytest -n 4 $PYTEST_ARGS --pyargs cartopy;

after_failure:
  - source activate $ENV_NAME
  - python -c "from __future__ import print_function; import cartopy.tests.mpl; print(cartopy.tests.mpl.failed_images_html())"

deploy:
  - provider: pypi
    user: scitools-cartopy
    # travis encrypt <password>
    password:
      secure: Wbc/NQkcEsWVGn3hTemLbaDond6dtAO46Q6PVSS0GiL9RU0bH6QIpLq34JV5hKRuhooFp8WaU49OJsH71iMB4Utrr1y8olkwpTuq7BBsuZGSHtStX0T4UKUCAHynlLnCEqIyBBDIWFsIy6OnLZDnKmPkqLW8IdQfk0aWl0mDv5w=
    distributions: sdist
    upload_docs: false
    on:
      repo: SciTools/cartopy
      condition: $NAME == "Latest everything."
      tags: true
